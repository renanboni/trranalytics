name: Release

on:
  push:
    tags:
      - 'v*' # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Extract version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v$VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Tag: $TAG"

      - name: Create tag (for manual releases)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.get_version.outputs.tag }}" -m "Release ${{ steps.get_version.outputs.version }}"
          git push origin "${{ steps.get_version.outputs.tag }}"

      - name: Generate analytics events
        run: ./gradlew :shared:generateAnalyticsEvents

      - name: Build Android artifacts
        env:
          RELEASE_VERSION: ${{ steps.get_version.outputs.version }}
        run: ./gradlew :shared:assemble

      - name: Build XCFramework
        id: xcframework
        run: |
          ./gradlew :shared:linkReleaseFrameworkIosArm64 :shared:linkReleaseFrameworkIosSimulatorArm64
          rm -rf Shared.xcframework
          xcodebuild -create-xcframework \
            -framework shared/build/bin/iosArm64/releaseFramework/Shared.framework \
            -framework shared/build/bin/iosSimulatorArm64/releaseFramework/Shared.framework \
            -output Shared.xcframework

          # Zip for release and compute checksum
          zip -r Shared.xcframework.zip Shared.xcframework
          CHECKSUM=$(swift package compute-checksum Shared.xcframework.zip)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          RELEASE_VERSION: ${{ steps.get_version.outputs.version }}
        run: ./gradlew :shared:publish

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags ${{ steps.get_version.outputs.tag }}^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release"
            CHANGELOG="Initial release"
          else
            echo "Previous tag: $PREVIOUS_TAG"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..${{ steps.get_version.outputs.tag }})
          fi

          # Write changelog to file for multiline output
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.tag }}
          body_path: changelog.txt
          files: Shared.xcframework.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Package.swift and TypeScript types
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          CHECKSUM=${{ steps.xcframework.outputs.checksum }}

          # Checkout main branch and pull latest
          git fetch origin main
          git checkout main
          git pull origin main

          # Update Package.swift with new version and checksum
          sed -i '' "s|let version = \".*\"|let version = \"$VERSION\"|g" Package.swift
          sed -i '' "s|let checksum = \".*\"|let checksum = \"$CHECKSUM\"|g" Package.swift

          # Update TypeScript types
          cp shared/build/generated/source/analytics/typescript/*.ts types/

          # Update types/package.json version
          sed -i '' "s|\"version\": \".*\"|\"version\": \"$VERSION\"|g" types/package.json

          # Commit and push updates
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift types/
          git commit -m "Update Package.swift and TypeScript types for version $VERSION [skip ci]" || echo "No changes to commit"
          git push origin main

      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} TRRAnalytics Release ${{ steps.get_version.outputs.tag }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && '‚úÖ Release Published' || '‚ùå Release Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n${{ steps.get_version.outputs.tag }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ job.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ job.status == 'success' && 'üéâ *Release artifacts published successfully!*\n\n*Available on:*\n‚Ä¢ GitHub Packages (Android)\n‚Ä¢ Swift Package Manager (iOS)\n‚Ä¢ TypeScript types in types/ folder' || '‚ö†Ô∏è *Release workflow encountered an error.*\n\nPlease check the workflow logs for details.' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ job.status == 'success' && 'üì¶ View Release' || 'üîç View Logs' }}"
                      },
                      "url": "${{ job.status == 'success' && format('https://github.com/{0}/releases/tag/{1}', github.repository, steps.get_version.outputs.tag) || format('https://github.com/{0}/actions/runs/{1}', github.repository, github.run_id) }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
